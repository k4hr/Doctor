// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DoctorStatus {
  DRAFT
  PENDING
  NEED_FIX
  APPROVED
  REJECTED
}

enum DoctorFileKind {
  PROFILE_PHOTO
  DIPLOMA_PHOTO
}

// NEW
enum QuestionStatus {
  OPEN
  IN_PROGRESS
  DONE
}

// NEW
enum QuestionFileKind {
  PHOTO
}

model Doctor {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submittedAt DateTime?
  status      DoctorStatus @default(DRAFT)

  telegramId        String  @unique
  telegramUsername  String?
  telegramFirstName String?
  telegramLastName  String?

  lastName   String
  firstName  String
  middleName String?
  gender     String
  birthDay   Int?
  birthMonth Int?
  birthYear  Int?
  city       String?

  speciality1     String
  speciality2     String?
  speciality3     String?
  education       String
  degree          String?
  workplace       String?
  position        String?
  experienceYears Int
  awards          String?

  email String

  about             String
  specialityDetails String
  experienceDetails String
  courses           String?
  achievements      String?
  publications      String?

  files DoctorFile[]

  // NEW: вопросы назначенные врачу (фильтр "вопросы этого врача")
  assignedQuestions Question[] @relation("AssignedDoctor")

  // NEW: вопросы, на которые врач реально ответил (статистика/рейтинг потом)
  answeredQuestions Question[] @relation("AnsweredDoctor")

  @@index([status])
  @@index([speciality1])
  @@index([city])
  @@index([submittedAt])
}

model DoctorFile {
  id        String         @id @default(cuid())
  createdAt DateTime       @default(now())

  doctorId  String
  doctor    Doctor         @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  kind      DoctorFileKind
  url       String
  mime      String?
  sizeBytes Int?
  sortOrder Int            @default(0)

  @@index([doctorId])
  @@index([kind])
  @@index([doctorId, kind])
  @@index([doctorId, kind, sortOrder])
}

// NEW
model Question {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Автор (пациент) — Telegram WebApp user
  authorTelegramId String
  authorUsername   String?
  authorFirstName  String?
  authorLastName   String?

  // Категория (раздел медицины)
  speciality String

  // Заголовок + текст вопроса
  title String
  body  String

  // Ключевые слова (нормализованные) — для поиска
  keywords String[] @default([])

  status QuestionStatus @default(OPEN)

  // Назначение на конкретного врача (опционально)
  assignedDoctorId String?
  assignedDoctor   Doctor? @relation("AssignedDoctor", fields: [assignedDoctorId], references: [id], onDelete: SetNull)

  // Кто ответил (опционально, когда появится логика ответов)
  answeredByDoctorId String?
  answeredByDoctor   Doctor? @relation("AnsweredDoctor", fields: [answeredByDoctorId], references: [id], onDelete: SetNull)

  files QuestionFile[]

  @@index([speciality])
  @@index([status])
  @@index([createdAt])
  @@index([assignedDoctorId])
  @@index([answeredByDoctorId])
}

model QuestionFile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  kind      QuestionFileKind
  url       String
  mime      String?
  sizeBytes Int?
  sortOrder Int      @default(0)

  @@index([questionId])
  @@index([kind])
  @@index([questionId, kind])
  @@index([questionId, kind, sortOrder])
}
