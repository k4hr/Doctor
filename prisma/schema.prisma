// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DoctorStatus {
  DRAFT
  PENDING
  NEED_FIX
  APPROVED
  REJECTED
}

enum DoctorFileKind {
  PROFILE_PHOTO
  DIPLOMA_PHOTO
}

enum QuestionStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum QuestionFileKind {
  PHOTO
}

model Doctor {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submittedAt DateTime?
  status      DoctorStatus @default(DRAFT)

  telegramId        String  @unique
  telegramUsername  String?
  telegramFirstName String?
  telegramLastName  String?

  lastName   String
  firstName  String
  middleName String?
  gender     String
  birthDay   Int?
  birthMonth Int?
  birthYear  Int?
  city       String?

  speciality1     String
  speciality2     String?
  speciality3     String?
  education       String
  degree          String?
  workplace       String?
  position        String?
  experienceYears Int
  awards          String?

  email String

  about             String
  specialityDetails String
  experienceDetails String
  courses           String?
  achievements      String?
  publications      String?

  files DoctorFile[]

  assignedQuestions Question[] @relation("AssignedDoctor")
  answeredQuestions Question[] @relation("AnsweredDoctor")

  @@index([status])
  @@index([speciality1])
  @@index([city])
  @@index([submittedAt])
}

model DoctorFile {
  id        String         @id @default(cuid())
  createdAt DateTime       @default(now())

  doctorId  String
  doctor    Doctor         @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  kind      DoctorFileKind
  url       String
  mime      String?
  sizeBytes Int?
  sortOrder Int            @default(0)

  @@index([doctorId])
  @@index([kind])
  @@index([doctorId, kind])
  @@index([doctorId, kind, sortOrder])
}

model Question {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorTelegramId String
  authorUsername   String?
  authorFirstName  String?
  authorLastName   String?

  // ✅ новое: выбор анонимности
  authorIsAnonymous Boolean @default(true)

  speciality String

  title String
  body  String

  keywords String[] @default([])

  status QuestionStatus @default(OPEN)

  assignedDoctorId String?
  assignedDoctor   Doctor? @relation("AssignedDoctor", fields: [assignedDoctorId], references: [id], onDelete: SetNull)

  answeredByDoctorId String?
  answeredByDoctor   Doctor? @relation("AnsweredDoctor", fields: [answeredByDoctorId], references: [id], onDelete: SetNull)

  files QuestionFile[]

  @@index([speciality])
  @@index([status])
  @@index([createdAt])
  @@index([assignedDoctorId])
  @@index([answeredByDoctorId])
}

model QuestionFile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  kind      QuestionFileKind
  url       String
  mime      String?
  sizeBytes Int?
  sortOrder Int      @default(0)

  @@index([questionId])
  @@index([kind])
  @@index([questionId, kind])
  @@index([questionId, kind, sortOrder])
}
